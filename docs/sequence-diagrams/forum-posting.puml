@startuml Forum Posting and Interaction Flow

' ============================================
' NIHONGO MASTER - COMMUNITY FORUM FLOW
' Sequence Diagram for Post Creation & Moderation
' ============================================

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title Community Forum - Post Creation and Interaction

actor "User" as U
actor "Admin" as A
participant "Next.js\nFrontend" as FE #LightBlue
participant "API Gateway" as GW #LightGray
participant "Community\nController" as CC #LightGreen
participant "Community\nService" as CS #LightGreen
participant "Moderation\nService" as MS #Orange
participant "Notification\nService" as NS #Yellow
participant "Search\nService" as SS #Pink
database "MongoDB" as DB #LightCoral
participant "Content\nFilter API" as CF #Red

== Creating a New Post ==

U -> FE: Navigate to /community
activate FE

FE -> GW: GET /api/community/categories
activate GW
GW --> FE: Available categories
deactivate GW

FE --> U: Display forum with categories

U -> FE: Click "New Post"
FE --> U: Show post creation form

U -> FE: Fill form:\n- Title\n- Category\n- Content (markdown)\n- Tags\n- Attachments

U -> FE: Click "Submit Post"

FE -> FE: Client-side validation\n(title length, content required)

FE -> GW: POST /api/community/posts
note right: Request body:\n{\n  title: "JLPT N3 Study Tips",\n  category: "jlpt-tips",\n  content: "Here are my tips...",\n  tags: ["N3", "grammar", "tips"],\n  attachments: []\n}
activate GW

GW -> CC: createPost(userId, postDTO)
activate CC
CC -> CS: createPost(userId, postDTO)
activate CS

' Content Moderation Check
CS -> MS: checkContent(postDTO)
activate MS

MS -> CF: POST /moderate
note right: Send title + content\nfor automated moderation
activate CF
CF -> CF: Check for:\n- Spam patterns\n- Inappropriate content\n- Links to malicious sites\n- Profanity filter
CF --> MS: ModerationResult
deactivate CF

alt Content flagged
    MS --> CS: ContentFlagged (reason)
    CS --> CC: PostRejected (reason)
    CC --> GW: 400 Bad Request
    GW --> FE: Error: Content policy violation
    FE --> U: Show error message\n"Your post contains..."
else Content approved
    MS --> CS: ContentApproved
    deactivate MS
end

CS -> DB: Insert Post document\nStatus: PUBLISHED
activate DB
DB --> CS: Post created (postId)
deactivate DB

' Index for search
CS -> SS: indexPost(post)
activate SS
SS -> SS: Add to search index\n(Elasticsearch/Atlas Search)
SS --> CS: Indexed
deactivate SS

' Award XP for contribution
CS -> DB: Update user XP\n(+10 for new post)
activate DB
DB --> CS: Updated
deactivate DB

CS --> CC: Created Post
deactivate CS
CC --> GW: PostDTO (201 Created)
deactivate CC
GW --> FE: New post data
deactivate GW

FE -> FE: Redirect to post page
FE --> U: Display created post\n"Your post is now live!"

deactivate FE

== Viewing and Interacting with Posts ==

U -> FE: Browse /community/jlpt-tips
activate FE

FE -> GW: GET /api/community/posts?category=jlpt-tips&page=1
activate GW
GW -> CC: getPostsByCategory("jlpt-tips", pageable)
activate CC
CC -> CS: findByCategory("jlpt-tips", pageable)
activate CS

CS -> DB: Query posts with pagination
activate DB
note right: Uses index:\n{category: 1, createdAt: -1}
DB --> CS: Page<Post>
deactivate DB

CS -> DB: Lookup author info\nfor each post
activate DB
DB --> CS: Author details
deactivate DB

CS --> CC: Page<PostWithAuthor>
deactivate CS
CC --> GW: Page<PostDTO>
deactivate CC
GW --> FE: Paginated posts
deactivate GW

FE --> U: Display post list

U -> FE: Click on a post
FE -> GW: GET /api/community/posts/{postId}
activate GW
GW -> CC: getPost(postId, userId)
activate CC
CC -> CS: findById(postId)
activate CS

CS -> DB: Find post\nIncrement view count
activate DB
DB --> CS: Post document
deactivate DB

CS -> DB: Get comments\nfor this post
activate DB
DB --> CS: Comments with authors
deactivate DB

CS -> CS: Check if user has liked

CS --> CC: PostWithComments
deactivate CS
CC --> GW: PostDetailDTO
deactivate CC
GW --> FE: Full post data
deactivate GW

FE --> U: Display post with:\n- Content\n- Author info\n- Comments\n- Like button

== Liking a Post ==

U -> FE: Click "Like" (heart button)

FE -> GW: POST /api/community/posts/{postId}/like
activate GW
GW -> CC: likePost(postId, userId)
activate CC
CC -> CS: toggleLike(postId, userId)
activate CS

CS -> DB: Check if already liked
activate DB
DB --> CS: Existing like status
deactivate DB

alt Not liked yet
    CS -> DB: Add userId to likes array\nIncrement likeCount
    activate DB
    DB --> CS: Updated
    deactivate DB

    ' Notify post author
    CS -> NS: notifyPostLiked(postAuthorId, userId, postId)
    activate NS
    NS -> DB: Create notification
    activate DB
    DB --> NS: Saved
    deactivate DB
    NS --> CS: Notified
    deactivate NS

    CS --> CC: {liked: true, likeCount: 42}
else Already liked
    CS -> DB: Remove userId from likes array\nDecrement likeCount
    activate DB
    DB --> CS: Updated
    deactivate DB
    CS --> CC: {liked: false, likeCount: 41}
end

deactivate CS
CC --> GW: LikeResultDTO
deactivate CC
GW --> FE: Like status
deactivate GW

FE -> FE: Update heart button state\nAnimate like count
FE --> U: Show updated like count

== Adding a Comment ==

U -> FE: Type comment and submit

FE -> GW: POST /api/community/posts/{postId}/comments
note right: Request: { content: "Great tips!" }
activate GW

GW -> CC: addComment(postId, userId, commentDTO)
activate CC
CC -> CS: createComment(postId, userId, content)
activate CS

' Content check
CS -> MS: checkContent(comment)
activate MS
MS --> CS: Approved
deactivate MS

CS -> DB: Insert Comment\nIncrement post.commentCount
activate DB
DB --> CS: Comment created
deactivate DB

' Notify post author
CS -> NS: notifyNewComment(postAuthorId, commenterId, postId)
activate NS
NS --> CS: Notified
deactivate NS

CS --> CC: Created Comment
deactivate CS
CC --> GW: CommentDTO
deactivate CC
GW --> FE: New comment
deactivate GW

FE -> FE: Prepend comment to list
FE --> U: Show new comment

deactivate FE

== Reporting Content (User) ==

U -> FE: Click "Report" on suspicious post
activate FE

FE --> U: Show report dialog\n(Select reason)

U -> FE: Select "Spam" and submit

FE -> GW: POST /api/community/posts/{postId}/report
activate GW
GW -> CC: reportPost(postId, userId, reason)
activate CC
CC -> MS: createReport(postId, userId, reason)
activate MS

MS -> DB: Create Report document
activate DB
DB --> MS: Report saved
deactivate DB

MS -> MS: Check report threshold\n(e.g., 3+ reports = auto-flag)

alt Threshold reached
    MS -> DB: Update post status to FLAGGED
    activate DB
    DB --> MS: Updated
    deactivate DB

    MS -> NS: notifyAdmins("Post flagged for review")
    activate NS
    NS --> MS: Admins notified
    deactivate NS
end

MS --> CC: ReportAcknowledged
deactivate MS
CC --> GW: Success
deactivate CC
GW --> FE: "Report submitted"
deactivate GW

FE --> U: "Thank you for reporting.\nOur team will review."

deactivate FE

== Admin Moderation ==

A -> FE: Navigate to /admin/moderation
activate FE

FE -> GW: GET /api/admin/moderation/flagged
activate GW
GW -> CC: getFlaggedContent()
activate CC
CC -> MS: getFlaggedPosts()
activate MS
MS -> DB: Query flagged posts
activate DB
DB --> MS: Flagged posts with reports
deactivate DB
MS --> CC: Flagged content list
deactivate MS
CC --> GW: ModerationQueueDTO
deactivate CC
GW --> FE: Flagged items
deactivate GW

FE --> A: Display moderation queue

A -> FE: Review post\nSelect "Delete Post"

FE -> GW: POST /api/admin/moderation/action
note right: Action: DELETE_POST
activate GW

GW -> CC: moderateContent(action)
activate CC
CC -> MS: executeAction(postId, DELETE)
activate MS

MS -> DB: Update post status to DELETED\n(soft delete)
activate DB
DB --> MS: Updated
deactivate DB

MS -> NS: notifyUser(postAuthorId, "Post removed")
activate NS
NS --> MS: Notified
deactivate NS

MS -> MS: Log moderation action

MS --> CC: ActionCompleted
deactivate MS
CC --> GW: Success
deactivate CC
GW --> FE: "Post deleted"
deactivate GW

FE --> A: Update queue\nShow next item

deactivate FE

@enduml
