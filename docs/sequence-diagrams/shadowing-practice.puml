@startuml Shadowing Practice with AI Flow

' ============================================
' NIHONGO MASTER - SHADOWING PRACTICE FLOW
' Sequence Diagram for AI-Powered Practice
' ============================================

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

title Shadowing Practice Session with AI Feedback

actor "User" as U
participant "Next.js\nFrontend" as FE #LightBlue
participant "API Gateway" as GW #LightGray
participant "Practice\nController" as PC #LightGreen
participant "Practice\nService" as PS #LightGreen
participant "Video\nService" as VS #LightYellow
participant "AI\nService" as AI #Orange
participant "Review\nService" as RS #Pink
database "MongoDB" as DB #LightCoral
participant "External\nAI API" as EXT #Red
participant "Cloud\nStorage" as CS #Purple

== Session Initialization ==

U -> FE: Select video for shadowing
activate FE

FE -> GW: GET /api/videos/{videoId}
activate GW
GW -> PC: Forward request
activate PC
PC -> VS: getVideoById(videoId)
activate VS
VS -> DB: findById(videoId)
activate DB
DB --> VS: Video document
deactivate DB
VS --> PC: Video with transcript
deactivate VS
PC --> GW: VideoDTO
deactivate PC
GW --> FE: Video details + segments
deactivate GW

FE -> FE: Load video player\nwith transcript segments
FE --> U: Display video\nwith practice UI

U -> FE: Click "Start Practice"
FE -> GW: POST /api/practice/sessions
activate GW
GW -> PC: startSession(userId, videoId, SHADOWING)
activate PC
PC -> PS: createSession(userId, videoId, mode)
activate PS
PS -> DB: Insert PracticeSession
activate DB
DB --> PS: sessionId
deactivate DB
PS --> PC: PracticeSession
deactivate PS
PC --> GW: PracticeSessionDTO
deactivate PC
GW --> FE: Session created (sessionId)
deactivate GW

FE --> U: Show segment 1\nReady to record

== Practice Loop (per segment) ==

loop For each transcript segment

    U -> FE: Play segment audio
    FE -> FE: Play video segment\n(startTime to endTime)
    FE --> U: Listen to native audio

    U -> FE: Click "Record" button
    FE -> FE: Start audio recording\n(WebRTC MediaRecorder)
    FE --> U: Recording indicator ON

    U -> U: Speak Japanese\n(shadow the segment)

    U -> FE: Click "Stop Recording"
    FE -> FE: Stop recording\nConvert to audio blob

    FE -> CS: Upload audio file
    activate CS
    CS --> FE: Audio URL
    deactivate CS

    FE -> GW: POST /api/practice/sessions/{sessionId}/attempts
    note right: Request body:\n- segmentIndex\n- audioUrl\n- referenceText
    activate GW

    GW -> PC: submitAttempt(sessionId, attemptDTO)
    activate PC
    PC -> PS: processAttempt(sessionId, attemptDTO)
    activate PS

    ' AI Processing
    PS -> AI: analyzeRecording(audioUrl, referenceText)
    activate AI

    AI -> EXT: POST /speech-to-text
    activate EXT
    note right: Send audio for\ntranscription
    EXT --> AI: Transcribed text
    deactivate EXT

    AI -> EXT: POST /pronunciation-analysis
    activate EXT
    note right: Compare with reference\nAnalyze phonemes
    EXT --> AI: Analysis result
    deactivate EXT

    AI -> AI: Calculate scores:\n- Pronunciation (0-100)\n- Speed match (0-100)\n- Intonation (0-100)

    AI -> AI: Generate feedback\nand improvement tips

    AI --> PS: AIAnalysisResult
    deactivate AI

    PS -> DB: Update PracticeSession\nwith attempt results
    activate DB
    DB --> PS: Updated
    deactivate DB

    PS --> PC: PracticeAttempt with scores
    deactivate PS
    PC --> GW: AttemptResultDTO
    deactivate PC
    GW --> FE: Attempt result
    deactivate GW

    FE -> FE: Display scores\nand feedback
    FE --> U: Show pronunciation: 85%\nShow speed: 78%\nShow intonation: 82%\nShow specific tips

    alt User wants to retry
        U -> FE: Click "Retry Segment"
        FE --> U: Ready to record again
    else Continue to next
        U -> FE: Click "Next Segment"
        FE --> U: Show next segment
    end

end

== Session Completion ==

U -> FE: Complete all segments
FE -> GW: POST /api/practice/sessions/{sessionId}/complete
activate GW
GW -> PC: completeSession(sessionId)
activate PC
PC -> PS: finalizeSession(sessionId)
activate PS

PS -> PS: Calculate overall scores\nAggregate all attempts

PS -> AI: generateSessionFeedback(allAttempts)
activate AI
AI -> AI: Analyze patterns\nIdentify strengths\nFind areas to improve
AI --> PS: Comprehensive AIFeedback
deactivate AI

PS -> DB: Update session as completed\nStore final feedback
activate DB
DB --> PS: Session updated
deactivate DB

' Update user progress
PS -> DB: Update UserProgress\n(increment videos completed,\nadd practice minutes,\nupdate skill scores)
activate DB
DB --> PS: Progress updated
deactivate DB

' Schedule for review
PS -> RS: scheduleForReview(userId, videoId)
activate RS
RS -> RS: Calculate initial SRS interval
RS -> DB: Create ReviewItem
activate DB
DB --> RS: ReviewItem created
deactivate DB
RS --> PS: Review scheduled
deactivate RS

PS --> PC: Completed session with feedback
deactivate PS
PC --> GW: SessionResultDTO
deactivate PC
GW --> FE: Session results
deactivate GW

FE -> FE: Display results dashboard
FE --> U: Show overall score: 82%\nShow improvement areas\nShow XP earned: +50\nShow next review date

== Achievement Check ==

FE -> GW: GET /api/users/me/achievements/check
activate GW
GW -> PC: checkAchievements(userId)
PC -> DB: Check achievement criteria
activate DB
DB --> PC: New achievements unlocked
deactivate DB
PC --> GW: List of new achievements
GW --> FE: AchievementDTO[]
deactivate GW

alt New achievements unlocked
    FE --> U: Display achievement\nunlock animation
end

deactivate FE

@enduml
